# Руководство по развертыванию на хостинге Beget

Это руководство объясняет, как развернуть систему Telegram-бота-воронки TG-Otvet на хостинге Beget.

## Требования

- Активный аккаунт на хостинге Beget
- Доменное имя, указывающее на ваш хостинг Beget
- Включенный доступ по SSH (если требуется)
- Поддержка Python 3.8+ на сервере

## Метод 1: Использование панели управления Beget (Рекомендуется)

### Шаг 1: Загрузка файлов
1. Перейдите в панель управления Beget
2. Используйте файловый менеджер для загрузки всех файлов проекта в каталог вашего домена (например, `~/domains/yourdomain.com/`)
3. Или используйте FTP/SFTP для загрузки файлов

### Шаг 2: Настройка Python-приложения
1. В панели управления перейдите в "Сайты" → "Python"
2. Нажмите "Добавить Python-приложение"
3. Заполните форму:
   - Домен: ваш домен
   - Корень приложения: `/domains/yourdomain.com` (или путь к вашему проекту)
   - Файл приложения: `app.py`
   - Объект приложения: `application`
   - Версия Python: 3.9 или выше
   - Виртуальное окружение: `.venv` (или ваше предпочтительное имя)

### Шаг 3: Установка зависимостей
1. В разделе управления Python-приложением вы можете установить пакеты
2. Или используйте SSH для установки: `pip install -r requirements.txt`

### Шаг 4: Настройка переменных окружения
1. Создайте файл `.env` в корне проекта на основе `.env.example`
2. Добавьте токен бота и другие значения конфигурации

### Шаг 5: Настройка базы данных
1. Приложение использует SQLite по умолчанию
2. Убедитесь, что файл `bot.db` имеет права на запись
3. Или настройте конфигурацию базы данных в `.env`

## Метод 2: Использование SSH (Для продвинутых)

### Шаг 1: Подключение по SSH
```bash
ssh username@yourdomain.com
```

### Шаг 2: Клонирование или загрузка проекта
```bash
# Если используете git
git clone https://your-repo-url.git

# Или загрузите файлы через SFTP в каталог вашего домена
```

### Шаг 3: Настройка виртуального окружения
```bash
cd ~/domains/yourdomain.com  # или каталог вашего проекта
python3 -m venv .venv
source .venv/bin/activate
```

### Шаг 4: Установка зависимостей
```bash
pip install --upgrade pip
pip install -r requirements.txt
```

### Шаг 5: Настройка окружения
```bash
cp .env.example .env
# Отредактируйте .env с вашей конфигурацией
nano .env
```

### Шаг 6: Настройка базы данных
```bash
python init_db.py
```

### Шаг 7: Установка прав доступа к файлам
```bash
chmod -R 755 media/
chmod 64 .env
```

## Запуск приложения

### Использование Gunicorn (Рекомендуется для продакшена)
```bash
gunicorn app:app -c gunicorn.conf.py
```

### Использование Uvicorn (Для разработки/тестирования)
```bash
uvicorn backend.api.main:app --host 0.0.0.0 --port 8000
```

## Конфигурация для Beget

### Использование панели управления
1. В настройках Python-приложения можно указать:
   - Точку входа: `app:application`
   - Рабочий каталог: корень вашего проекта
   - Переменные окружения непосредственно в панели управления

### Использование переменных окружения
Установите эти переменные в панели управления Beget или в файле .env:
- `BOT_TOKEN`: Токен вашего Telegram-бота
- `DATABASE_URL`: Строка подключения к базе данных (по умолчанию использует SQLite)
- `API_BASE_URL`: Публичный URL вашего API

## Настройка Telegram-бота

1. Создайте бота с помощью @BotFather в Telegram
2. Получите токен бота
3. Установите webhook URL на ваш эндпоинт API:
   ```
   https://api.telegram.org/bot<your_token>/setWebhook?url=https://yourdomain.com/webhook
   ```

## Конфигурация медиафайлов

Приложение хранит медиафайлы в каталоге `media/`. Убедитесь, что этот каталог:
- Имеет права на запись для веб-сервера
- Находится в правильном пути, как указано в вашей конфигурации
- Регулярно резервируется

## Конфигурация базы данных

Приложение использует SQLite по умолчанию, что подходит для небольших и средних приложений. Файл базы данных (`bot.db`) должен:
- Находиться в месте с правами на чтение/запись
- Регулярно резервироваться
- Находиться вне корня веба для безопасности (если возможно)

## Интеграция с фронтендом

Если вы обслуживаете фронтенд отдельно:
1. Соберите React-приложение: `npm run build` в каталоге frontend
2. Настройте ваш домен для обслуживания статических файлов из каталога сборки
3. Обновите эндпоинты API, чтобы они указывали на ваш бэкенд

## Устранение неполадок

### Распространенные проблемы:

1. **Ошибки прав доступа**: Убедитесь, что ваше приложение имеет права на запись в каталоги базы данных и медиафайлов
2. **Ошибки импорта**: Проверьте, что все зависимости установлены в правильном виртуальном окружении
3. **Ошибки подключения к базе данных**: Проверьте, что путь к файлу базы данных указан правильно и доступен
4. **Бот не отвечает**: Проверьте правильность токена бота и правильность настройки вебхука

### Проверка статуса приложения:
```bash
# Проверить запущенные процессы
ps aux | grep gunicorn

# Проверить логи приложения
tail -f /path/to/your/logs
```

## Рекомендации по безопасности

1. Никогда не сохраняйте файл `.env` в системе контроля версий
2. Используйте надежные пароли и API-ключи
3. Регулярно обновляйте зависимости
4. Мониторьте логи доступа на наличие подозрительной активности
5. Используйте HTTPS для всех коммуникаций

## Обновление приложения

1. Создайте резервную копию базы данных и конфигурации
2. Загрузите новые файлы через FTP/SFTP или git pull
3. Обновите зависимости: `pip install -r requirements.txt --upgrade`
4. Перезапустите Python-приложение из панели управления

## Поддержка

Если вы столкнетесь с проблемами при развертывании:
1. Проверьте базу знаний Beget для получения руководств по Python-приложениям
2. Просмотрите логи приложения
3. Убедитесь, что все зависимости совместимы с окружением Beget
4. Обратитесь в службу поддержки Beget для решения проблем, связанных с сервером

## Деплой фронтенда на Netlify

Для развертывания фронтенда на Netlify выполните следующие шаги:

### Шаг 1: Подготовка проекта
1. Убедитесь, что у вас есть аккаунт на [Netlify](https://www.netlify.com/)
2. В файле `frontend/.env.production` укажите URL вашего бэкенда:
   ```
   VITE_API_URL=https://your-beget-domain.com
   ```

### Шаг 2: Сборка проекта
В корневом каталоге frontend выполните:
```bash
npm install
npm run build
```

### Шаг 3: Деплой на Netlify
#### Метод 1: Через интерфейс Netlify
1. Зайдите в панель управления Netlify
2. Нажмите "Add new site" → "Deploy with drag and drop"
3. Перетащите папку `frontend/dist` (или `frontend/build`, в зависимости от конфигурации) в окно браузера

#### Метод 2: Через Git
1. Закоммитьте изменения в репозитории
2. Добавьте репозиторий в Netlify через "Add new site" → "Import an existing project"
3. Выберите ваш репозиторий и настройте деплой:
   - Build command: `cd frontend && npm install && npm run build`
   - Publish directory: `frontend/dist`

#### Метод 3: Использование CLI
1. Установите Netlify CLI: `npm install -g netlify-cli`
2. Войдите в аккаунт: `netlify login`
3. Перейдите в каталог frontend: `cd frontend`
4. Выполните деплой: `netlify deploy --prod`

### Шаг 4: Настройка переменных окружения
Если вы используете метод Git или CLI, добавьте переменные окружения в настройках сайта:
- Перейдите в "Site settings" → "Build & deploy" → "Environment"
- Добавьте переменную: `VITE_API_URL` со значением URL вашего бэкенда на Beget

### Шаг 5: Настройка переадресации (если необходимо)
Если вы используете маршрутизацию в React, создайте файл `public/_redirects` в папке сборки:
```
/*    /index.html    200
```

### Настройка кастомного домена (опционально)
1. В настройках сайта на Netlify перейдите в "Domain settings"
2. Добавьте ваш домен
3. Обновите DNS-записи у регистратора домена

После деплоя вы получите URL вида `https://your-site-name.netlify.app`, который можно использовать для доступа к фронтенду.