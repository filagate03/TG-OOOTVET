# Руководство по деплою приложения TG-Otvet

## Деплой бэкенда на Beget

### Подготовка к деплою

1. Убедитесь, что у вас есть аккаунт на [Beget](https://beget.com)
2. Включите SSH-доступ в настройках хостинга
3. Подготовьте файлы для деплоя

### Установка приложения на Beget

1. Загрузите проект на сервер через FTP или Git
2. Установите Python-зависимости:
   ```bash
   pip install -r requirements_production.txt
   ```
3. Создайте файл `.env` с настройками:
   ```env
   BOT_TOKEN=ваш_токен_бота
   DATABASE_URL=sqlite:///./bot.db
   FRONTEND_URL=https://ваш_сайт.netlify.app
   NETLIFY_URL=https://ваш_сайт.netlify.app
   ENVIRONMENT=production
   SECRET_KEY=ваш_секретный_ключ
   ```
4. Запустите миграции базы данных:
   ```bash
   python init_db.py
   ```
5. Запустите приложение с помощью Gunicorn:
   ```bash
   gunicorn -c gunicorn.conf.py app:application
   ```

### Настройка веб-сервера

1. В панели управления Beget перейдите в раздел "Настройка веб-сервера"
2. Укажите путь до точки входа: `app.py`
3. Установите версию Python 3.9 или выше
4. Перезапустите веб-сервер

## Деплой фронта на Netlify

### Подготовка к деплою

1. Убедитесь, что у вас есть аккаунт на [Netlify](https://netlify.com)
2. Подготовьте проект к деплою

### Деплой через Git

1. Загрузите ваш фронтенд-проект на GitHub/GitLab/Bitbucket
2. Залогиньтесь в Netlify и нажмите "New site from Git"
3. Выберите репозиторий с вашим фронтендом
4. В настройках деплоя укажите:
   - Build Command: `npm run build`
   - Publish directory: `dist`
   - Environment variables:
     - `VITE_API_URL`: (необязательно) - при использовании проксирования через Netlify оставьте пустым

### Деплой через ZIP-архив

1. Соберите проект локально:
   ```bash
   npm run build
   ```
2. Загрузите получившуюся папку `dist` на Netlify через drag-and-drop

## Настройка взаимодействия между фронтендом и бэкендом

### CORS настройки

В файле `backend/core/config.py` настроены разрешенные источники:
- Локальный фронтенд: `http://localhost:5173`
- Деплоенный фронтенд: `https://*.netlify.app`

### Проксирование через Netlify (Решение проблемы Mixed Content)

Для решения проблемы с разными протоколами (HTTPS на Netlify и HTTP на Beget) используйте проксирование через Netlify.

1. Создайте файл `netlify.toml` в корне проекта:
   ```toml
   [build]
    publish = "dist"  # Папка с собранным фронтендом
     command = "npm run build" # Команда сборки
   
   [[redirects]]
     from = "/api/*"
     to = "http://ВАШ_IP_АДРЕС:ВАШ_ПОРТ/:splat"  # ЗАМЕНИТЕ НА СВОЙ IP И ПОРТ
     status = 200
     force = true
   ```

2. Измените настройки API в файле `frontend/src/lib/api.js`:
   - Установите `API_BASE` в пустую строку или относительный путь
   - Все запросы к API должны использовать относительные пути (например, `/api/projects` вместо `http://.../api/projects`)

3. Настройте бэкенд на Beget:
   - Убедитесь, что сервер слушает `0.0.0.0` вместо `127.0.0.1` или `localhost`
   - При необходимости настройте firewall, чтобы разрешить входящие соединения на порт бэкенда

### Переменные окружения

#### Для бэкенда:
- `FRONTEND_URL`: URL вашего фронтенда на Netlify
- `NETLIFY_URL`: URL вашего фронтенда на Netlify
- `ENVIRONMENT`: "production" для продакшена

#### Для фронтенда:
- `VITE_API_URL`: При использовании проксирования через Netlify можно оставить пустым

## Проверка работоспособности

После деплоя проверьте:

1. Доступность API по URL: `https://ваш_сайт.netlify.app/api/projects` (должно проксировать на ваш бэкенд)
2. Доступность фронтенда по URL: `https://ваш_сайт.netlify.app`
3. Работоспособность всех функций: проектов, пользователей, воронки, рассылок
4. Загрузку и отображение медиафайлов
5. Работу бота с вашим Telegram-ботом

## Возможные проблемы и решения

### CORS ошибки и Mixed Content

- При использовании проксирования через Netlify проблема с CORS и Mixed Content должна исчезнуть
- Проверьте, что `netlify.toml` правильно настроен и размещен в корне проекта
- Убедитесь, что все API-запросы используют относительные пути

### Ошибки базы данных

- Проверьте права доступа к файлу базы данных
- Убедитесь, что путь к базе данных указан корректно

### Ошибки бота

- Проверьте, что `BOT_TOKEN` в `.env` указан правильно
- Убедитесь, что бот добавлен в нужные чаты и имеет необходимые права

## Обновление приложения

### Обновление бэкенда

1. Загрузите новые файлы на сервер
2. Обновите зависимости:
   ```bash
   pip install -r requirements_production.txt --upgrade
   ```
3. Выполните миграции при необходимости
4. Перезапустите приложение

### Обновление фронтенда

1. Запушьте изменения в репозиторий (если используется Git деплой)
2. Или перезалейте архив с новой сборкой (если используется ZIP деплой)